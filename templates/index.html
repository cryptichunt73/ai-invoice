<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Invoice Generator Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0c10;
      --panel: #14161a;
      --panel-2: #171a1f;
      --text: #e8ebf0;
      --muted: #aab3c0;
      --primary: #4f8cff;
      --primary-600: #3a73df;
      --border: #262a31;
      --accent: #2a2f39;
      --success: #14b87a;
      --warning: #facc15;
      --danger: #ef4444;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* Page */
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 500px at 10% -10%, #1d2331 0%, transparent 50%),
        radial-gradient(1200px 600px at 110% -20%, #1a2336 0%, transparent 45%),
        var(--bg);
      color: var(--text);
      font: 15px/1.5 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .container{
      max-width: 1180px;
      margin: 32px auto 120px;
      padding: 0 20px;
    }

    /* Header / Hero */
    .hero-gradient{
      background: radial-gradient(circle at 0% 0%, #223457 0, transparent 55%),
                  radial-gradient(circle at 120% 0%, #1d2540 0, transparent 55%),
                  linear-gradient(180deg, #151823, #10131c);
      border-radius: 22px;
      border: 1px solid rgba(120,140,200,.35);
      box-shadow: var(--shadow);
      padding: 22px 22px 18px;
      position: relative;
      overflow: hidden;
    }
    .hero-gradient::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(79,140,255,.28), transparent 55%),
        radial-gradient(circle at 120% 0%, rgba(86,196,255,.25), transparent 55%);
      opacity:.55;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    .hero-inner{
      position:relative;
      z-index:1;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:center;
    }
    .hero-left{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .hero-icon{
      width:46px;
      height:46px;
      border-radius:16px;
      background:rgba(12,17,32,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 20px rgba(0,0,0,.45);
      color:#c7ddff;
      font-size:22px;
      border:1px solid rgba(147,197,253,.3);
    }
    .hero-title{
      margin:0;
      font-size:26px;
      letter-spacing:.4px;
      font-weight:700;
    }
    .hero-subtitle{
      margin:4px 0 0;
      font-size:13px;
      color:#cbd5f5;
      opacity:.9;
    }
    .status-indicator{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(9,12,24,.8);
      border:1px solid rgba(148,163,234,.5);
      color:#e0e7ff;
    }
    .status-indicator span{
      letter-spacing:.4px;
    }
    .status-note{
      margin:4px 0 0;
      font-size:11.5px;
      color:#a5b4fc;
      opacity:.9;
      text-align:right;
    }

    .badge-pill{
      font-size: 11px;
      letter-spacing: .4px;
      color: #9ec0ff;
      background: #1a2950;
      border: 1px solid #233a75;
      padding: 4px 9px;
      border-radius: 999px;
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card-header{
      border-bottom:1px solid var(--border);
      padding-bottom:10px;
      margin-bottom:14px;
    }

    .section-title{
      margin:0;
      font-size:16px;
      letter-spacing:.35px;
      color:#e2e8f0;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .section-title i{
      font-size:15px;
      color:#7aa5ff;
    }
    .section-subtitle{
      margin:6px 0 0;
      font-size:12.5px;
      color:var(--muted);
    }

    /* Grid helpers */
    .grid-2{display:grid;gap:16px;grid-template-columns:1.1fr 1.3fr;}
    .grid-3{display:grid;gap:16px;grid-template-columns:1.2fr 1fr 1fr;}
    .grid-4{display:grid;gap:12px;grid-template-columns:repeat(4, minmax(0,1fr));}
    @media (max-width:1024px){
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}
    }

    /* Form controls */
    label.label{
      font-size:12.5px;
      color:var(--muted);
      letter-spacing:.35px;
      margin:6px 0 4px;
      display:block;
    }
    .input, textarea, select{
      width:100%;
      box-sizing:border-box;
      background:#101319;
      color:var(--text);
      border:1px solid var(--border);
      outline:none;
      padding:9px 11px;
      border-radius:var(--radius-sm);
      font-size:13px;
      transition:border-color .2s, box-shadow .2s, background .2s;
    }
    .input::placeholder,
    textarea::placeholder{
      color:#6b7280;
    }
    .input:focus, textarea:focus, select:focus{
      border-color:#355fb8;
      box-shadow:0 0 0 3px rgba(79,140,255,.18);
      background:#0f1218;
    }
    textarea{min-height:96px;resize:vertical;}

    select{
      background-image: linear-gradient(45deg, transparent 50%, #8594b0 50%),
                        linear-gradient(135deg, #8594b0 50%, transparent 50%),
                        linear-gradient(to right, #101319, #101319);
      background-position: calc(100% - 18px) 16px, calc(100% - 13px) 16px, 100% 0;
      background-size: 5px 5px, 5px 5px, 2.5em 3.5em;
      background-repeat: no-repeat;
      padding-right: 42px;
    }

    .hint-box{
      font-size:12.5px;
      color:var(--muted);
    }

    /* Buttons */
    .btn{
      appearance:none;
      cursor:pointer;
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      letter-spacing:.25px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:7px;
      background:#0f1218;
      color:var(--text);
      transition:background .18s, filter .18s, transform .1s, opacity .15s;
    }
    .btn:hover{
      background:#161a22;
    }
    .btn-primary{
      background:linear-gradient(180deg,var(--primary),var(--primary-600));
      border-color:#2c56c5;
      color:#fff;
    }
    .btn-primary:hover{filter:brightness(1.04);}
    .btn-secondary{
      background:#12151c;
    }
    .btn-secondary:hover{background:#171b23;}
    .btn-success{
      background:linear-gradient(180deg,#1dd89a,#0f9c68);
      border-color:#089767;
      color:#f0fdf4;
    }
    .btn-warning{
      background:linear-gradient(180deg,#facc15,#eab308);
      border-color:#eab308;
      color:#111827;
    }
    .btn-danger{
      background:linear-gradient(180deg,#ef4444,#b91c1c);
      border-color:#b91c1c;
      color:#fee2e2;
    }

    /* NEW: disabled button visual */
    .btn[disabled]{
      opacity:0.55;
      cursor:not-allowed;
      pointer-events:none;
    }

    .pill{
      font-size:11px;
      background:#1a2950;
      color:#bfdbfe;
      padding:4px 9px;
      border-radius:999px;
      font-weight:500;
      border:1px solid #233a75;
      letter-spacing:.35px;
    }

    /* Item rows */
    .item-row{
      background:#101319;
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:12px 12px 10px;
      margin-bottom:10px;
    }

    .item-row .grid{
      display:grid;
      gap:10px;
      grid-template-columns:0.55fr 1.1fr 2.1fr 0.7fr 0.8fr 0.9fr 1fr;
    }
    @media (max-width:900px){
      .item-row .grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    .item-row-footer{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
      padding-top:8px;
      border-top:1px solid var(--border);
    }

    .text-sm-muted{
      font-size:12px;
      color:var(--muted);
    }

    .divider{
      height:1px;
      background:var(--border);
      margin:10px 0;
    }

    .fade-in{
      animation: fadeIn .25s ease-out;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:translateY(0);}
    }

    /* Result box */
    #result{
      margin-top:12px;
    }
    #result.hidden{
      display:none;
    }
    #resultBody a{
      color:#93c5fd;
      text-decoration:underline;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="hero-gradient">
      <div class="hero-inner">
        <div class="hero-left">
          <div class="hero-icon">
            <i class="fas fa-file-invoice"></i>
          </div>
          <div>
            <h1 class="hero-title">Invoice Generator Pro</h1>
            <p class="hero-subtitle">Professional invoice creation made simple</p>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="status-indicator">
            <i class="fas fa-database"></i>
            <span id="companyCount">0 companies</span>
          </div>
          <p class="status-note">Templates stored locally in your browser</p>
        </div>
      </div>
    </header>

    <!-- Auto-Generate Items (Gemini) -->
    <div class="card fade-in" style="margin-top:22px;">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-wand-magic-sparkles"></i>
          Auto-Generate Items (Gemini)
        </h2>
        <p class="section-subtitle">
          Enter a company and a target total; we‚Äôll research what they do and propose invoice items you can paste below.
        </p>
      </div>

      <div class="grid-3">
        <div>
          <label class="label"><i class="fas fa-building" style="margin-right:6px;"></i>Company</label>
          <input id="gen_company" class="input" placeholder="e.g., Clair Electronics Private Limited">
        </div>
        <div>
          <label class="label"><i class="fas fa-sack-dollar" style="margin-right:6px;"></i>Total</label>
          <input id="gen_total" class="input" placeholder="e.g., 100000">
        </div>
        <div>
          <label class="label"><i class="fas fa-globe" style="margin-right:6px;"></i>Currency</label>
          <input id="gen_currency" class="input" value="INR" placeholder="USD / INR">
        </div>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;">
        <button type="button" class="btn btn-secondary" id="genItemsBtn">
          <i class="fas fa-wand-magic-sparkles"></i>
          Generate with Gemini
        </button>
        <span class="pill" id="genStatus" style="display:none;">Working‚Ä¶</span>
      </div>

      <div style="margin-top:16px;">
        <label class="label"><i class="fas fa-clipboard" style="margin-right:6px;"></i>Generated (copy below or auto-fill)</label>
        <textarea id="gen_output" class="input" rows="8"
          placeholder="Generated text will appear here, ready to paste into the box below."></textarea>
        <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="copyToPasteBtn">
            <i class="fas fa-arrow-down"></i> Copy to ‚ÄúPaste Invoice Data‚Äù
          </button>
          <button type="button" class="btn btn-success" id="applyToFormBtn" title="Fill the item rows directly">
            <i class="fas fa-list-check"></i> Fill Items in Form
          </button>
        </div>
      </div>
    </div>

    <!-- Smart Data Extraction -->
    <div class="card fade-in" style="margin-top:22px;">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-magic"></i>
          Smart Data Extraction
        </h2>
        <p class="section-subtitle">Paste your invoice data and let AI extract the information automatically</p>
      </div>

      <div class="space-y-4">
        <div>
          <label class="label">
            <i class="fas fa-paste" style="margin-right:6px;"></i>
            Paste Invoice Data
          </label>
          <textarea
            id="pasteBox"
            class="input"
            rows="8"
            placeholder="Paste your invoice details here...

Example:
PI No: FTP2025001
Date: Jan 15, 2025
Buyer: ABC Company
Items: - SKU001; LED Light; Qty 100; Rate 25.50"
          ></textarea>
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:10px;">
          <button type="button" class="btn btn-secondary" id="parseBtn">
            <i class="fas fa-cogs"></i>
            Smart Parse
          </button>
          <button type="button" class="btn btn-primary" id="llmParseBtn">
            <i class="fas fa-brain"></i>
            AI Extract
          </button>
          <button type="button" class="btn btn-warning" id="clearPasteBtn">
            <i class="fas fa-eraser"></i>
            Clear
          </button>
        </div>

        <div class="card" style="background:#10121a;margin-top:14px;">
          <div style="display:flex;gap:10px;align-items:flex-start;">
            <i class="fas fa-lightbulb" style="color:#7aa5ff;margin-top:2px;"></i>
            <div class="hint-box">
              <h4 style="margin:0 0 6px;font-size:13px;color:#e2e8f0;">Supported Formats:</h4>
              <ul style="padding-left:16px;margin:0;list-style:disc;font-size:12.5px;">
                <li>Labels: "PI No, Date, POL, POD, Buyer/Notify, Category"</li>
                <li>Items: "- CODE; Description; Qty N; Rate R"</li>
                <li>Bank details: "Account Name, Account No, SWIFT"</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Company Management -->
    <div class="card fade-in" style="margin-top:22px;">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-building"></i>
          Company Management
        </h2>
        <p class="section-subtitle">Select an existing company template or create a new one</p>
      </div>

      <div class="grid-3" style="align-items:flex-end;">
        <div>
          <label class="label">
            <i class="fas fa-list" style="margin-right:6px;"></i>
            Choose Existing Company
          </label>
          <select id="companySelect" class="input">
            <option value="">‚Äî Select company ‚Äî</option>
          </select>
        </div>
        <div>
          <label class="label">
            <i class="fas fa-plus" style="margin-right:6px;"></i>
            Or Type New Company Name
          </label>
          <input
            id="company_name"
            name="company_name"
            class="input"
            placeholder="Enter company name..."
          />
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-success" id="loadTemplateBtn" title="Loads the template for selected company">
            <i class="fas fa-download"></i>
            Load Template
          </button>
          <button class="btn btn-danger" id="clearBtn">
            <i class="fas fa-trash"></i>
            Clear All
          </button>
        </div>
      </div>
    </div>

    <!-- FORM -->
    <form id="invoiceForm" class="space-y-8" style="margin-top:22px;">
      <!-- Company & Meta Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-info-circle"></i>
            Company & Invoice Details
          </h2>
          <p class="section-subtitle">Basic company information and invoice metadata</p>
        </div>

        <div class="grid-2">
          <div>
            <label class="label">
              <i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>
              Company Address
            </label>
            <textarea
              class="input"
              id="company_addr"
              name="company_addr"
              rows="4"
              placeholder="Enter your company address..."
            ></textarea>
          </div>
          <div class="space-y-4">
            <div class="grid-2" style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
              <div>
                <label class="label">
                  <i class="fas fa-tag" style="margin-right:6px;"></i>
                  Invoice Title
                </label>
                <input
                  class="input"
                  id="title"
                  name="title"
                  value="PROFORMA INVOICE"
                  placeholder="Invoice title..."
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-hashtag" style="margin-right:6px;"></i>
                  PI Number
                </label>
                <input
                  class="input"
                  id="pi_no"
                  name="pi_no"
                  placeholder="FTP2025XXXX"
                />
              </div>
            </div>
            <div class="grid-2" style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
              <div>
                <label class="label">
                  <i class="fas fa-calendar" style="margin-right:6px;"></i>
                  Date
                </label>
                <input
                  class="input"
                  id="date"
                  name="date"
                  placeholder="JAN.04,2025"
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-shipping-fast" style="margin-right:6px;"></i>
                  Shipment Method
                </label>
                <input
                  class="input"
                  id="shipment"
                  name="shipment"
                  placeholder="VIA SEA"
                />
              </div>
            </div>
            <div class="grid-2" style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
              <div>
                <label class="label">
                  <i class="fas fa-anchor" style="margin-right:6px;"></i>
                  Port of Loading
                </label>
                <input
                  class="input"
                  id="port_loading"
                  name="port_loading"
                  placeholder="CHINA"
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-map-pin" style="margin-right:6px;"></i>
                  Port of Discharge
                </label>
                <input
                  class="input"
                  id="port_discharge"
                  name="port_discharge"
                  placeholder="CHENNAI, INDIA"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buyer & Notify Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-users"></i>
            Buyer & Notify Party
          </h2>
          <p class="section-subtitle">Customer and notification party information</p>
        </div>

        <div class="grid-2">
          <div class="space-y-4">
            <div>
              <label class="label">
                <i class="fas fa-user" style="margin-right:6px;"></i>
                Buyer Name
              </label>
              <input
                class="input"
                id="buyer_name"
                name="buyer_name"
                placeholder="Enter buyer company name..."
              />
            </div>
            <div>
              <label class="label">
                <i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>
                Buyer Address
              </label>
              <textarea
                class="input"
                id="buyer_addr"
                name="buyer_addr"
                rows="4"
                placeholder="Enter buyer address..."
              ></textarea>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <label class="label">
                <i class="fas fa-bell" style="margin-right:6px;"></i>
                Notify Party Name
              </label>
              <input
                class="input"
                id="notify_name"
                name="notify_name"
                placeholder="Enter notify party name..."
              />
            </div>
            <div>
              <label class="label">
                <i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>
                Notify Party Address
              </label>
              <textarea
                class="input"
                id="notify_addr"
                name="notify_addr"
                rows="4"
                placeholder="Enter notify party address..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-tags"></i>
            Product Category
          </h2>
          <p class="section-subtitle">Specify the category of products being invoiced</p>
        </div>

        <div>
          <label class="label">
            <i class="fas fa-folder" style="margin-right:6px;"></i>
            Category
          </label>
          <input
            class="input"
            id="category"
            name="category"
            placeholder="LED LIGHTING FIXTURES AND SPARES"
          />
        </div>
      </div>

      <!-- Items Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-list-alt"></i>
            Invoice Items
          </h2>
          <p class="section-subtitle">Add products or services to your invoice</p>
        </div>

        <div id="items"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
          <button type="button" class="btn btn-primary" id="addItemBtn">
            <i class="fas fa-plus"></i>
            Add Item
          </button>
          <div class="text-sm-muted">
            <i class="fas fa-info-circle" style="margin-right:4px;"></i>
            Click "Add Item" to add products or services
          </div>
        </div>
      </div>

      <!-- Totals & Bank Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-calculator"></i>
            Totals & Banking Information
          </h2>
          <p class="section-subtitle">Final amounts and payment details</p>
        </div>

        <div class="grid-2">
          <div>
            <label class="label">
              <i class="fas fa-dollar-sign" style="margin-right:6px;"></i>
              Total Amount
            </label>
            <input
              class="input"
              id="total"
              name="total"
              placeholder="100000.00"
              style="font-size:16px;font-weight:600;"
            />
          </div>
          <div class="space-y-4">
            <div class="grid-2" style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
              <div>
                <label class="label">
                  <i class="fas fa-user" style="margin-right:6px;"></i>
                  Account Holder Name
                </label>
                <input
                  class="input"
                  id="bank_account_name"
                  placeholder="Account holder name..."
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-credit-card" style="margin-right:6px;"></i>
                  Account Number
                </label>
                <input
                  class="input"
                  id="bank_account_no"
                  placeholder="Account number..."
                />
              </div>
            </div>
            <div class="grid-2" style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
              <div>
                <label class="label">
                  <i class="fas fa-university" style="margin-right:6px;"></i>
                  Bank Name
                </label>
                <input
                  class="input"
                  id="bank_name"
                  placeholder="Bank name..."
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-code" style="margin-right:6px;"></i>
                  SWIFT Code
                </label>
                <input
                  class="input"
                  id="bank_swift"
                  placeholder="SWIFT code..."
                />
              </div>
            </div>
            <div>
              <label class="label">
                <i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>
                Account Holder Address
              </label>
              <textarea
                class="input"
                id="bank_account_addr"
                rows="2"
                placeholder="Account holder address..."
              ></textarea>
            </div>
            <div>
              <label class="label">
                <i class="fas fa-building" style="margin-right:6px;"></i>
                Bank Branch Address
              </label>
              <textarea
                class="input"
                id="bank_addr"
                rows="2"
                placeholder="Bank branch address..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card fade-in">
        <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center;align-items:center;">
          <button type="button" class="btn btn-primary" style="padding:10px 26px;font-size:14px;" id="generateBtn">
            <i class="fas fa-file-pdf"></i>
            Generate Invoice
          </button>

          <!-- NEW: generate loading pill -->
          <span
            id="generateStatus"
            class="pill"
            style="display:none; align-items:center; gap:6px;"
          >
            <i class="fas fa-circle-notch fa-spin"></i>
            Generating‚Ä¶
          </span>

          <button type="button" class="btn btn-success" style="padding:10px 26px;font-size:14px;" id="saveTemplateBtn" title="Saves/updates template for current company">
            <i class="fas fa-save"></i>
            Save Template
          </button>
        </div>
      </div>
    </form>

    <!-- Result Section -->
    <div id="result" class="card fade-in hidden">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-check-circle"></i>
          Result
        </h2>
      </div>
      <div id="resultBody"></div>
    </div>
  </div>

<script>
"use strict";

function $(id){ return document.getElementById(id); }
function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

/* ----------------- Gemini Auto-Generate handlers ----------------- */
async function generateWithGemini(){
  const company = $('gen_company')?.value?.trim();
  const total   = $('gen_total')?.value?.trim();
  const currency= $('gen_currency')?.value?.trim() || 'USD';
  const status  = $('genStatus');
  const outBox  = $('gen_output');
  if(!company || !total){ showResult('Enter company and total first.'); return; }
  try{
    if(status){ status.style.display='inline-flex'; status.textContent='Working‚Ä¶'; }
    const res = await fetch('/api/suggest_items_text', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ company_name: company, total, currency, n_items: 6 })
    });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if(outBox) outBox.value = data.text || '';
    showResult('‚úÖ Generated items. You can paste them below or auto-fill items.');
  }catch(e){
    showResult('Gemini error: ' + e.message);
  }finally{
    if(status) status.style.display='none';
  }
}
function copyGenToPaste(){
  const src = $('gen_output'), dst = $('pasteBox');
  if(!src || !dst){ showResult('Missing boxes'); return; }
  dst.value = src.value || '';
  showResult('Copied to ‚ÄúPaste Invoice Data‚Äù. Now click Smart Parse or AI Extract.');
}
async function applyGenToForm(){
  const company = $('gen_company')?.value?.trim();
  const total   = $('gen_total')?.value?.trim();
  const currency= $('gen_currency')?.value?.trim() || 'USD';
  if(!company || !total){ showResult('Enter company and total first.'); return; }
  try{
    const res = await fetch('/api/suggest_items', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ company_name: company, total, currency, n_items: 6 })
    });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    // Replace items
    const itemsWrap = $('items');
    if(itemsWrap) itemsWrap.innerHTML = '';
    (data.items || []).forEach((it,i)=> addItem(it, i+1));
    // Update total
    if($('total')) $('total').value = data.total || total;
    showResult('‚úÖ Filled items in the form.');
  }catch(e){
    showResult('Apply items error: ' + e.message);
  }
}

/* ----------------- Existing app logic ----------------- */
const itemRowHTML = () => `
  <div class="item-row fade-in">
    <div class="grid">
      <div>
        <label class="label" style="font-size:11px;">SL.NO</label>
        <input class="input it-slno" style="text-align:center;" />
      </div>
      <div>
        <label class="label" style="font-size:11px;">ITEM NO.</label>
        <input class="input it-itemno" placeholder="SKU-0001"/>
      </div>
      <div>
        <label class="label" style="font-size:11px;">DESCRIPTION</label>
        <input class="input it-desc" placeholder="Product Description"/>
      </div>
      <div>
        <label class="label" style="font-size:11px;">QTY</label>
        <input class="input it-qty" style="text-align:center;" value="1"/>
      </div>
      <div>
        <label class="label" style="font-size:11px;">UNIT</label>
        <input class="input it-unit" style="text-align:center;" value="NOS"/>
      </div>
      <div>
        <label class="label" style="font-size:11px;">RATE</label>
        <input class="input it-rate" style="text-align:right;" value="0.00"/>
      </div>
      <div>
        <label class="label" style="font-size:11px;">AMOUNT</label>
        <input class="input it-amount" style="text-align:right;font-weight:600;" value="0.00"/>
      </div>
    </div>
    <div class="item-row-footer">
      <button type="button" class="btn btn-danger btn-sm removeItemBtn">
        <i class="fas fa-trash"></i>
        Remove Item
      </button>
    </div>
  </div>
`;

function addItem(prefill=null, index=null){
  const list = $('items');
  if (!list) { console.warn("[items] container missing"); return; }
  list.insertAdjacentHTML('beforeend', itemRowHTML());
  const row = qsa('.item-row', list).at(-1);
  if (!row) return;
  const set = (sel, v) => { const el=row.querySelector(sel); if (el && v!=null) el.value = v; };
  const i = index ?? qsa('.item-row', list).length;
  set('.it-slno', prefill?.slno ?? String(i));
  set('.it-itemno', prefill?.item_no ?? 'SKU-0001');
  set('.it-desc', prefill?.description ?? 'Product Description');
  set('.it-qty', prefill?.quantity ?? '1');
  set('.it-unit', prefill?.unit ?? 'NOS');
  set('.it-rate', prefill?.rate ?? '0.00');
  set('.it-amount', prefill?.amount ?? '0.00');
  const rm = row.querySelector('.removeItemBtn');
  if (rm) rm.addEventListener('click', () => row.remove());
}

function collectForm() {
  const items = qsa('.item-row').map((row, i) => ({
    slno: (row.querySelector('.it-slno')?.value || String(i+1)),
    item_no: row.querySelector('.it-itemno')?.value || '',
    description: row.querySelector('.it-desc')?.value || '',
    quantity: row.querySelector('.it-qty')?.value || '',
    unit: row.querySelector('.it-unit')?.value || '',
    rate: row.querySelector('.it-rate')?.value || '',
    amount: row.querySelector('.it-amount')?.value || '',
  }));

  return {
    company_name: $('company_name')?.value || $('companySelect')?.value || '',
    company_addr: $('company_addr')?.value || '',
    title: $('title')?.value || 'PROFORMA INVOICE',
    pi_no: $('pi_no')?.value || '',
    date: $('date')?.value || '',
    shipment: $('shipment')?.value || '',
    port_loading: $('port_loading')?.value || '',
    port_discharge: $('port_discharge')?.value || '',
    buyer_name: $('buyer_name')?.value || '',
    buyer_addr: $('buyer_addr')?.value || '',
    notify_name: $('notify_name')?.value || '',
    notify_addr: $('notify_addr')?.value || '',
    category: $('category')?.value || '',
    items,
    total: $('total')?.value || '',
    bank: {
      account_name: $('bank_account_name')?.value || '',
      account_addr: $('bank_account_addr')?.value || '',
      account_no: $('bank_account_no')?.value || '',
      bank_name: $('bank_name')?.value || '',
      bank_addr: $('bank_addr')?.value || '',
      swift: $('bank_swift')?.value || ''
    }
  };
}

function fillForm(d) {
  const safe = (k, v) => { const el=$(k); if (el) el.value = v ?? ''; };
  safe('company_name', d.company_name);
  safe('company_addr', d.company_addr);
  safe('title', d.title ?? 'PROFORMA INVOICE');
  safe('pi_no', d.pi_no);
  safe('date', d.date);
  safe('shipment', d.shipment);
  safe('port_loading', d.port_loading);
  safe('port_discharge', d.port_discharge);
  safe('buyer_name', d.buyer_name);
  safe('buyer_addr', d.buyer_addr);
  safe('notify_name', d.notify_name);
  safe('notify_addr', d.notify_addr);
  safe('category', d.category);
  safe('total', d.total);

  const bank = d.bank || {};
  safe('bank_account_name', bank.account_name);
  safe('bank_account_addr', bank.account_addr);
  safe('bank_account_no', bank.account_no);
  safe('bank_name', bank.bank_name);
  safe('bank_addr', bank.bank_addr);
  safe('bank_swift', bank.swift);

  const itemsWrap = $('items');
  if (itemsWrap) itemsWrap.innerHTML = '';
  (d.items || []).forEach((it, i) => addItem(it, i+1));
  if (!d.items || d.items.length === 0) addItem(null, 1);
}

async function loadCompanies() {
  try {
    const res = await fetch('/api/companies');
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    const sel = $('companySelect');
    if (!sel) return;

    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = '‚Äî Select company ‚Äî';
    sel.appendChild(opt0);

    data.slugs.forEach((slug, i) => {
      const opt = document.createElement('option');
      opt.value = data.pretty[i];
      opt.textContent = data.pretty[i];
      sel.appendChild(opt);
    });
    if ($('companyCount')) $('companyCount').textContent = (data.pretty?.length || 0) + ' companies';
  } catch (e) {
    console.error('Failed to load companies', e);
  }
}

async function fetchTemplateForSelected() {
  const name = $('companySelect')?.value?.trim();
  if (!name) return;
  try {
    const res = await fetch('/api/template?name=' + encodeURIComponent(name));
    if (!res.ok) throw new Error(await res.text());
    const d = await res.json();
    fillForm(d);
    if ($('company_name')) $('company_name').value = name;
  } catch (e) {
    console.error('Failed to load template', e);
    showResult('Error loading template: ' + e.message);
  }
}

async function saveTemplate() {
  const payload = collectForm();
  try {
    const res = await fetch('/api/save_template', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const d = await res.json();
    showResult(d.message || 'Saved template.');
    await loadCompanies();
  } catch (e) {
    showResult('Error saving template: ' + e.message);
  }
}

async function generateInvoice() {
  const payload = collectForm();
  const btn = $('generateBtn');
  const status = $('generateStatus');

  try {
    // turn ON loading state
    if (btn) {
      btn.disabled = true;
    }
    if (status) {
      status.style.display = 'inline-flex';
      status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Generating‚Ä¶';
    }

    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(err);
    }
    const d = await res.json();
    showResult(`Saved: <a href="${d.download_url}" target="_blank">${d.filename}</a><br/>Folder: ${d.dir}`);
    await loadCompanies();
  } catch (e) {
    showResult('Error generating invoice: ' + e.message);
  } finally {
    // turn OFF loading state
    if (btn) {
      btn.disabled = false;
    }
    if (status) {
      status.style.display = 'none';
    }
  }
}

async function parseAndFill() {
  const txt = document.getElementById('pasteBox')?.value || '';
  if (!txt.trim()) { showResult('Paste something first üôÇ'); return; }
  try {
    const res = await fetch('/api/parse_paste', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ text: txt })
    });
    if (!res.ok) throw new Error(await res.text());
    const d = await res.json();
    fillForm(d);
    showResult('Parsed and filled the form.');
  } catch (e) {
    showResult('Parse error: ' + e.message);
    console.error(e);
  }
}

async function llmParseAndFill() {
  const txt = document.getElementById('pasteBox')?.value || '';
  if (!txt.trim()) { showResult('Paste something first üôÇ'); return; }
  try {
    const res = await fetch('/api/llm_extract', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ text: txt })
    });
    if (!res.ok) throw new Error(await res.text());
    const d = await res.json();
    fillForm(d);
    showResult('LLM extracted and filled the form.');
  } catch (e) {
    showResult('LLM parse error: ' + e.message);
    console.error(e);
  }
}

function showResult(html) {
  const box = $('result');
  const body = $('resultBody');
  if (box && body) {
    body.innerHTML = html;
    box.classList.remove('hidden');
  }
}

/* Bind all buttons on load */
document.addEventListener('DOMContentLoaded', () => {
  try {
    loadCompanies();
    addItem(null, 1);

    $('genItemsBtn')?.addEventListener('click', generateWithGemini);
    $('copyToPasteBtn')?.addEventListener('click', copyGenToPaste);
    $('applyToFormBtn')?.addEventListener('click', applyGenToForm);

    $('addItemBtn')?.addEventListener('click', () => addItem());
    $('loadTemplateBtn')?.addEventListener('click', fetchTemplateForSelected);
    $('saveTemplateBtn')?.addEventListener('click', saveTemplate);
    $('generateBtn')?.addEventListener('click', generateInvoice);
    $('clearBtn')?.addEventListener('click', () => fillForm({items: []}));
    $('parseBtn')?.addEventListener('click', parseAndFill);
    $('llmParseBtn')?.addEventListener('click', llmParseAndFill);
    $('clearPasteBtn')?.addEventListener('click', () => { const pb=$('pasteBox'); if(pb) pb.value=''; });
  } catch (e) {
    console.error('Init error:', e);
  }
});
</script>
</body>
</html>
